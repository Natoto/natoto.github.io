---
layout: post
title:  slo-moæ…¢åŠ¨ä½œè§†é¢‘å¤„ç†
tag: React Native
date: 2018-07-26 

---

#slo-moæ…¢åŠ¨ä½œè§†é¢‘å¤„ç†
slo-moæ¨¡å¼æ˜¯iOSç³»ç»Ÿæ‹æ‘„æ¨¡å¼çš„ä¸€ç§ï¼Œè·Ÿå…¶ä»–æ¨¡å¼åœ¨å­˜å‚¨æ–¹å¼ä¸Šé¢å’Œæœ‰ç€æœ¬è´¨çš„åŒºåˆ«,å¦‚ä¸‹æ…¢åŠ¨ä½œæ¼”ç¤º
 
 [æ¼”ç¤ºè§†é¢‘ğŸ‘‡](https://test.noizztv.com/article/share?id=9208285652934558845&s_bucket=na)
 
<iframe 
    height=480 
    width=270  src="https://test.noizztv.com/article/share?id=9208285652934558845&s_bucket=na" 
    frameborder=0 
    allowfullscreen>
</iframe>
æ–‡ç« ä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ 
>1. æ…¢åŠ¨ä½œè§†é¢‘æ—¶é•¿
>2.  æ…¢åŠ¨ä½œè§†é¢‘æ’­æ”¾åŸç†
>3. å¯¼å‡ºè§†é¢‘
>4. æ…¢åŠ¨ä½œè§†é¢‘çš„ç¼–è¾‘æ›´æ–°

---
###  iOSç³»ç»Ÿç›¸å†Œçš„bug
ç³»ç»Ÿç›¸å†Œæœ‰ä¸ªbugï¼Œæ…¢åŠ¨ä½œè§†é¢‘æ—¶é•¿æ˜¾ç¤ºçš„æ˜¯å…¶æ‹æ‘„æ—¶é•¿ï¼Œè€Œéè§†é¢‘çœŸå®æ’­æ”¾æ—¶é•¿
![å®é™…æ—¶é•¿ä¸º8ç§’](https://upload-images.jianshu.io/upload_images/1091358-27ceb5bf639aea44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### iOSç³»ç»Ÿå¦‚ä½•æ’­æ”¾æ…¢åŠ¨ä½œè§†é¢‘çš„

slo-moæ¨¡å¼çš„è§†é¢‘åœ¨ç›¸å†Œä¸­å­˜å‚¨çš„æ˜¯æ­£å¸¸æ‹æ‘„çš„åŸè§†é¢‘ï¼Œå…¶åœ¨æ’­æ”¾çš„æ—¶å€™è¯»å–æœ¬åœ°æ‹æ‘„æ—¶å­˜å‚¨çš„æ…¢æ‹ä¿¡æ¯ï¼Œæ§åˆ¶æ’­æ”¾é€Ÿåº¦ï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ…¢åŠ¨ä½œè§†é¢‘ï¼Œè¿™æ ·åšçŒœæµ‹æ˜¯ä¸ºäº†æ’­æ”¾å’Œå±•ç¤ºæ•ˆç‡ï¼Œ`å› ä¸ºè§†é¢‘å¯¼å‡ºæ˜¯å¾ˆæ…¢çš„`ï¼Œpsï¼šé‡è¦çš„äº‹é«˜äº®è¯´ã€‚

### iOSç³»ç»Ÿå¦‚ä½•ç¼–è¾‘æ…¢æ‹è§†é¢‘
æ™®é€šçš„è§†é¢‘åªæœ‰è£å‰ªçš„åŠŸèƒ½ï¼Œè€Œslo-moæ…¢åŠ¨ä½œæ¨¡å¼çš„è§†é¢‘æ”¯æŒæ…¢æ”¾åŒºåŸŸçš„é€‰å–ï¼Œè¿™ä¸ªå½±å“çœŸå®æ—¶é•¿ï¼Œä½†æ˜¯ä¸ä¼šåˆæˆä¸ºæ–°çš„æ…¢æ‹è§†é¢‘ï¼Œåªæ˜¯æ›´æ–°æ…¢æ‹ä¿¡æ¯ï¼Œæ§åˆ¶æ’­æ”¾æ—¶å€™æ’­æ”¾é€Ÿç‡

![image.png](https://upload-images.jianshu.io/upload_images/1091358-f2a95666c0e2e74f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


----

æœ‰ä¸ªè®¤çŸ¥å‰æï¼ŒiOSç›®å‰è·å–è§†é¢‘è·å–ç›¸å†Œéƒ½æ˜¯é€šè¿‡PHFetchResult
### è·å–æ‰€æœ‰ç›¸å†Œ

```

/**
 è·å–æ‰€æœ‰å†…å®¹ä¸ä¸ºç©ºçš„çš„ç›¸å†Œ
 */
- (NSArray <PHAssetCollection *> *)_PHFetchAllUserAlbum:(YYPLFetchOptions *)options{
    NSMutableArray *assetAlbums = [NSMutableArray array];
    PHFetchResult *result = nil;
    if (options.disableSmartAlbum) {
        // ç›¸æœºèƒ¶å·
        result = [PHAssetCollection fetchAssetCollectionsWithType:PHAssetCollectionTypeSmartAlbum subtype:PHAssetCollectionSubtypeSmartAlbumUserLibrary options:nil];
        
    } else {
        // æ‰€æœ‰æ™ºèƒ½ç›¸å†Œ
        result = [PHAssetCollection fetchAssetCollectionsWithType:PHAssetCollectionTypeSmartAlbum subtype:PHAssetCollectionSubtypeAny options:nil];
    }
    // ç³»ç»Ÿç›¸å†Œ+ç”¨æˆ·åˆ›å»º
    for (id elem in result) {
        if ([elem isKindOfClass:[PHAssetCollection class]]) {
            [assetAlbums addObject:elem];
        }
    }
    PHFetchResult *userCreate = [PHCollectionList fetchTopLevelUserCollectionsWithOptions:nil];
    for (id elem in userCreate) {
        if ([elem isKindOfClass:[PHAssetCollection class]]) {
            [assetAlbums addObject:elem];
        }
    }
    return [assetAlbums copy];
}

```

### æ£€æµ‹æ…¢æ‹åŠ¨ä½œçš„è§†é¢‘,99%çš„äººéƒ½ä¼šçŠ¯çš„é”™
requestAVAssetForVideoå›è°ƒè¿‡æ¥çš„assetç»å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯AVURLAssetï¼Œ
æ‰€è°“AVURLAssetå°±æ˜¯å¯ä»¥æ ¹æ®URLç›´æ¥ç´¢å¼•åˆ°è¿™ä¸ªè§†é¢‘ï¼Œç„¶è€Œå½“æœ‰æ…¢åŠ¨ä½œè¿™ç±»å‹çš„è§†é¢‘çš„æ—¶å€™å°±ä¸æ˜¯è¿™ç§ç±»å‹äº†ï¼Œè€Œæ˜¯AVCompositionæ¨¡å¼ã€‚

é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆå¤šæ•°æ—¶å€™éƒ½ä¸ä¼šæŠ¥é”™å‘¢ï¼Œå¦‚æœæ˜¯ç±»å‹ä¸åŒ¹é…æ—©å°±å´©æºƒäº†ï¼Œ
è¿™æ˜¯å› ä¸º` options.version =  PHVideoRequestOptionsVersionCurrent;`è¿™å¥è¯ï¼Œå¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯å†™æˆ`options.version =  PHVideoRequestOptionsVersionOriginal;` ç›´æ¥å–çš„åŸè§†é¢‘ï¼ŒåŸå›¾ç‰‡ï¼Œè€Œä¸æ˜¯ç¼–è¾‘ä¹‹åçš„ï¼Œå› ä¸ºç›¸æœºæ‹å®Œä¸€å®šæ˜¯å­˜äº†ä¸€ä¸ªåŸè§†é¢‘çš„ï¼Œæ ¹æ®è¿™ä¸ªoriginalå»å–ä¸€å®šä¼šè¿”å›urlassetçš„ã€‚

```
- (NSString *)PH_requestRealFilePath
{
    __block NSString *filePath = nil;
    PHImageManager *imageManager = [PHImageManager defaultManager];
    switch (self.PH_asset.mediaType) {
        case PHAssetMediaTypeImage:
        {
            PHImageRequestOptions *options = [[PHImageRequestOptions alloc] init];
            options.version = PHImageRequestOptionsVersionOriginal;
            options.deliveryMode = PHImageRequestOptionsDeliveryModeHighQualityFormat;
            options.synchronous = YES; // use synchronous request
            [imageManager requestImageDataForAsset:self.PH_asset options:options resultHandler:^(NSData *imageData, NSString *dataUTI, UIImageOrientation orientation, NSDictionary *info) {
                NSURL *fileURL = info[@"PHImageFileURLKey"];
                if (fileURL) {
                    filePath = [fileURL absoluteString];
                }
            }];
            return filePath;
        }
        
        case PHAssetMediaTypeVideo:
        {
            dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
            PHVideoRequestOptions *options = [[PHVideoRequestOptions alloc] init];
            options.version =  PHVideoRequestOptionsVersionCurrent;
//            options.version =  PHVideoRequestOptionsVersionOriginal;
            @weakify(self);
            
          [imageManager cancelImageRequest:self.phReqId];
           __block PHImageRequestID   reqid = 0;
            reqid =   [imageManager requestAVAssetForVideo:self.PH_asset options:options resultHandler:^(AVAsset * _Nullable asset, AVAudioMix * _Nullable audioMix, NSDictionary * _Nullable info) {
                @strongify(self)
                if ([[asset class] isSubclassOfClass:[AVURLAsset class]]) {
                    filePath = [[(AVURLAsset *)asset URL] absoluteString];
                    self.AVURL_asset = (AVURLAsset*)asset;
                    dispatch_semaphore_signal(semaphore);
                }
                else if ([[asset class] isSubclassOfClass:[AVComposition class]]){
                   
                   reqid = [YYPLAsset getVideoPathFromPHAsset:self.asset  Complete:^(AVURLAsset *avurlAsset,NSString *path, NSString *fileName) {
                        LogInfo(@"YYPLAsset+PH", @"æ…¢èŠ‚å¥è§†é¢‘ï¼š%@", path);
                        filePath = path;
                        self.AVURL_asset = avurlAsset;
                        [self PH_duration];
                        dispatch_semaphore_signal(semaphore);
                   } progressblock:^(float progress) {
                       
                   }];
                    self.phReqId = reqid;
                }
            }];
            self.phReqId = reqid;
            dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
            return filePath;
        }
            
        default:
        {
            [YYLogger error:@"YYPLAsset+PH" message:@"self.PH_asset.mediaType is out of switch %zd",self.PH_asset.mediaType];
        }
            break;
    }
    return nil;
}
```
### å¦‚ä½•å–å¾—è§†é¢‘çš„çœŸå®æ—¶é•¿
æœ‰å‡ ç§è®¤è¯†çš„å±‚æ¬¡ï¼Œ
1. ç›´æ¥ä»phassetä¸­å»å–æ—¶é•¿ï¼Œ
2. phassetä¸­çš„æ˜¯ä¸å‡†ç¡®çš„
3. ä»å¯¼å‡ºä¹‹åçš„è§†é¢‘ä¸­å»è·å–
4. æˆ–è®¸è¿˜æœ‰å…¶ä»–çš„åŠæ³•å–å¾—
ç»è¿‡å‰é¢çš„é“ºå«æƒ³å¿…ä½ ä¸€å®šèƒ½è¾¾åˆ°ç¬¬ä¸‰ä¸ªå±‚æ¬¡äº†ï¼Œå› ä¸ºç›¸å†Œä¸­çš„durationæ˜¯ä¸å‡†ç¡®çš„ï¼Œé‚£åªæ˜¯æ‹æ‘„æ—¶å€™çš„æ—¶é•¿ï¼Œä½†æ˜¯ä»å¯¼å‡ºçš„è§†é¢‘ä¸­è·å–æœªå…ä¹Ÿå¤ªä¹…äº†ï¼Œ`å› ä¸ºè§†é¢‘å¯¼å‡ºæ—¶é—´å¾ˆè€—æ—¶` ï¼ŒåŒä¸Šï¼Œå†µä¸”æ—¶é•¿è€Œå·²å˜›ï¼Œä¸€å®šæ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Œå¦å¤–å¾®ä¿¡å¯ä»¥ç›´æ¥è¯»å–çœŸå®çš„æ…¢æ‹æ—¶é•¿ï¼Œè¿™ä¸ªæ—¶é—´å‡ ä¹å¿½ç•¥ä¸è®¡ï¼Œäºæ˜¯è¿˜å¾—å†æ‰¾æ‰¾ç›¸å…³çš„æ–¹æ³•ï¼Œäºæ˜¯æ‰¾åˆ°äº†è¿™ä¸ª

```

- (void)PH_getRealDuration:(void (^)(double dur))resultBlock
{
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    PHVideoRequestOptions *options = [[PHVideoRequestOptions alloc] init];
    //FIXME:é€‰æ‹©ä½¿ç”¨éå‡åŒ€é€Ÿç‡è§†é¢‘éœ€è¦æ”¹å›æ¥
    options.version =  PHVideoRequestOptionsVersionCurrent;
    __block double dur = 0;
    [[PHImageManager defaultManager] requestPlayerItemForVideo:self.PH_asset options:options resultHandler:^(AVPlayerItem * _Nullable playerItem, NSDictionary * _Nullable info) {
        dur = CMTimeGetSeconds(playerItem.duration);
        //æ…¢æ‹è§†é¢‘ playerItem.asset æ˜¯ä¸€ä¸ªAVCompositionçš„ç±»
        NSLog(@"è·å–çœŸå®æ–‡ä»¶æ—¶é•¿:%.2f",dur);
        dispatch_semaphore_signal(semaphore);
    }];
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
    if (!isnan(dur) && dur>0) {
        resultBlock(dur);
        return;
    }
    dur =  CMTimeGetSeconds(self.AVURL_asset.duration);
    if (isnan(dur) || !dur) {
        dur =  self.PH_asset.duration;
    }
    resultBlock(dur);
}

```

`requestPlayerItemForVideo ` apiå¯ä»¥è·å–playerItemï¼Œé‡Œé¢çš„durationå¯ä»¥è½¬æ¢ä¸ºçœŸå®æ—¶é•¿ï¼Œæ­¤æ–¹æ³•å¹¶ä¸è€—æ—¶ã€‚


### å¯¼å‡ºè§†é¢‘

æ…¢æ‹çœŸå®è§†é¢‘æ˜¯ä¸å­˜åœ¨çš„ï¼Œå¿…é¡»è¦é€šè¿‡è‡ªæœ‰çš„apiå¯¼å‡ºï¼Œå…¶åŸç†æ˜¯è¯»å–å½“æ—¶æ…¢æ‹ä¿å­˜çš„ä¿¡æ¯tracksç­‰è¿›è¡Œåˆ†æ­¥åˆæˆã€‚

```
 
static int getPHAssetRandomKey(){
    static int curRandomKey;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        curRandomKey = arc4random()%1000;
    });
    return curRandomKey;
}

typedef void(^ResultPath)(AVURLAsset *avurlAsset,NSString *filePath, NSString *fileName);

+ (PHImageRequestID)getVideoPathFromPHAsset:(PHAsset *)asset
                       Complete:(ResultPath)result
                  progressblock:(void (^)(float progress))progressblock
{
    NSArray *assetResources = [PHAssetResource assetResourcesForAsset:asset];
    PHAssetResource *resource;
    
    for (PHAssetResource *assetRes in assetResources) {
        if (@available(iOS 9.1, *)) {
            if (assetRes.type == PHAssetResourceTypePairedVideo ||
                assetRes.type == PHAssetResourceTypeVideo) {
                resource = assetRes;
            }
        } else {
            // Fallback on earlier versions
        }
    }
    NSString *fileName = @"tempAssetVideo.mov";
    if (resource.originalFilename) {
        fileName = resource.originalFilename;
    }
   
    if (@available(iOS 9.1, *)) {
        if (asset.mediaType == PHAssetMediaTypeVideo ||
            asset.mediaSubtypes == PHAssetMediaSubtypePhotoLive) {
            PHVideoRequestOptions *options = [[PHVideoRequestOptions alloc] init];
            options.version = PHImageRequestOptionsVersionCurrent;
            options.deliveryMode = PHImageRequestOptionsDeliveryModeHighQualityFormat;
             
        
            NSString *PATH_MOVIE_FILE = [NSTemporaryDirectory() stringByAppendingPathComponent:[NSString stringWithFormat:@"sol-mo-%d-%@",getPHAssetRandomKey(),fileName]];
            
            if ([[NSFileManager defaultManager] fileExistsAtPath:PATH_MOVIE_FILE]) {
                NSURL * url = [NSURL fileURLWithPath:PATH_MOVIE_FILE] ;
                NSDictionary *options = @{ AVURLAssetPreferPreciseDurationAndTimingKey : @YES };
                AVURLAsset *avasset = [[AVURLAsset alloc] initWithURL:url options:options];
                result(avasset,url.absoluteString,fileName);
                return 0;
            }
            [[NSFileManager defaultManager] removeItemAtPath:PATH_MOVIE_FILE error:nil];

            PHImageManager *manager = [PHImageManager defaultManager];
            PHImageRequestID reqid = [manager requestExportSessionForVideo:asset options:options exportPreset:AVAssetExportPreset960x540 resultHandler:^(AVAssetExportSession * _Nullable exportSession, NSDictionary * _Nullable info) {
                
                NSString *savePath = PATH_MOVIE_FILE;
                exportSession.outputURL = [NSURL fileURLWithPath:savePath];
                exportSession.shouldOptimizeForNetworkUse = NO;
                exportSession.outputFileType = AVFileTypeMPEG4;
                [exportSession exportAsynchronouslyWithCompletionHandler:^{
                    switch ([exportSession status]) {
                        case AVAssetExportSessionStatusCompleted:
                        {
                            NSURL * fileurl = [NSURL fileURLWithPath:PATH_MOVIE_FILE];
                            NSDictionary *options = @{ AVURLAssetPreferPreciseDurationAndTimingKey : @YES };
                            AVURLAsset *avasset = [[AVURLAsset alloc] initWithURL:fileurl options:options];
                            
                            result(avasset,fileurl.absoluteString,fileName);
                            break;
                        }
                        case AVAssetExportSessionStatusFailed:
                        case AVAssetExportSessionStatusCancelled:
                        default:
                        {
                            [[NSFileManager defaultManager] removeItemAtPath:PATH_MOVIE_FILE error:nil];
                            result(nil,nil, nil);
                            break;
                        }
                    }
                }];
                
            }];
            return reqid;
        } else {
            result(nil,nil, nil);
        }
    } else {
        // Fallback on earlier versions
    }
    return 0;
}
```

å†æ¬¡è¯´ä¸€å¥ï¼Œå¯¼å‡ºæ—¶é•¿æ˜¯æ¯”è¾ƒæ¼«é•¿çš„ï¼Œå¤§æ¦‚ä¸€åˆ†é’ŸçœŸå®æ—¶é•¿å¯¼å‡ºéœ€è¦åå¤šç§’ï¼Œè¿™æ ·å­çš„æƒ…å†µæµ‹è¯•æ˜¯ä¼šæbugçš„ï¼Œäº§å“å¯èƒ½æ˜¯ä¸ä¼šæ¥å—çš„ï¼Œé‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢

### ä¼˜åŒ–å¯¼å‡ºæ—¶é•¿
ç”±äºæ¶‰åŠåˆ°ç³»ç»Ÿçš„apiä½¿ç”¨ï¼Œç›®å‰ä»å¯¼å‡ºæ—¶é•¿ä¸Šé¢æ˜¯æ— æ³•ç¼©çŸ­åˆ°æ˜æ˜¾çš„åœ°æ­¥çš„
ä½†æ˜¯ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰æ—¶é•¿æ²¡é‚£ä¹ˆä¹…ï¼Œé‚£å°±å¯ä»¥åšå¾ˆå¤šäº‹æƒ…äº†
æœ‰ä»¥ä¸‹æ€è·¯
1. åŠ è¿›åº¦ï¼Œå¯¼å‡ºçš„è¿›åº¦æ²¡æœ‰å›è°ƒï¼Œæ²¡æœ‰kvoç›‘å¬ï¼Œä½†æ˜¯æœ‰ä¸ªprogresså¯ä»¥å®æ—¶è·å–ï¼Œè¿™é‡Œå¯ä»¥ç»™ä¸€ä¸ªå®šæ—¶å™¨å®æ—¶å»å–AVAssetExportSessionçš„progress
è‹¹æœçš„apiå¦‚æ˜¯è¯´ï¼Œ
```

/* Specifies the progress of the export on a scale from 0 to 1.0.  A value of 0 means the export has not yet begun, A value of 1.0 means the export is complete. This property is not key-value observable. */
@property (nonatomic, readonly) float progress;
```

2. åå°å»åˆæˆï¼Œä¸é˜»å¡ç”¨æˆ·å½“å‰æ“ä½œ
ä½†æ˜¯è¦åŒæ—¶å¤„ç†åˆæˆæˆåŠŸå’Œå¤±è´¥çš„æ—¶æœºï¼Œåœ¨ä¸šåŠ¡ä¸Šåšå¯¹åº”å¤„ç†

3. æ’­æ”¾å™¨ç›´æ¥æ”¯æŒAVCompontæ ¼å¼åˆ›å»ºæ’­æ”¾å™¨
è¿™ä¸ªæ–¹å¼å‡ ä¹ä¸ç”¨ä»»ä½•ç­‰å¾…ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥æ“ä½œï¼Œä¸iosç›¸å†Œæ’­æ”¾å™¨ä¸€æ ·å¤„ç†ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒå‹å¥½ã€‚ä½†æ˜¯ä»£ä»·å¤§ï¼Œéœ€è¦é‡å†™ä½ çš„æ’­æ”¾å™¨ç”Ÿæˆæ–¹å¼ã€‚

4. æˆ–è®¸ä½ è¿˜æœ‰å…¶ä»–çš„æ›´å¥½æ–¹å¼ï¼Œæ¬¢è¿ç•™è¨€
