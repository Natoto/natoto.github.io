---

layout: post
title: swiftä¸­çš„gcdä½¿ç”¨å¤§æ³•
tags: gcd,å¤šçº¿ç¨‹
date: 2017-06-26

---


### swiftä¸­çš„GCD

ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ä»‹ç»object-cä¸­çš„å¤šçº¿ç¨‹ï¼Œå„ç§æ‹¼å‡‘å…¶å®ä¸æ˜¯å¾ˆæ·±å…¥ï¼Œåªèƒ½å½“åšcookbookæ¥ç”¨ï¼Œç„¶åæœ¬æ¬¡swiftæ˜¯å®è·µçš„ä¸€ä¸ªç»“æœï¼Œæ¯å†™çš„ä¸€å¥ä»£ç éƒ½æ˜¯è‡ªå·±çš„ï¼Œå’Œç†è§£çš„ï¼Œå¦‚æœä¸ç†è§£ä¼šç”¨é€šä¿—ç›´ç™½è¯­è¨€é‡å¤ç†è§£ï¼Œæˆ–æŸ¥é˜…å…¶ä»–èµ„æ–™æ•´ç†åç›´è‡³ç†è§£æ‰å†™å‡ºæ¥çš„ã€‚

 

#### GCDä¸­OCä¸swiftæ›´æ–°å¯¹ç…§è¡¨

è‹±æ–‡ä¸å¥½çš„å¯ä»¥ç¿»è¯‘çœ‹ä¸€ä¸‹ç¿»è¯‘
#### dispatch è¯‘: åˆ†å‘,åˆ†æ´¾ï¼Œä»»åŠ¡åˆ†å‘

|object-c| swift | ç¿»è¯‘è§£é‡Š|
|-------|------| ---|
dispatch_ object_t|	DispatchObject | DispatchQueue,DispatchGroup,å’ŒDispatchSourceçš„åŸºç±»å«æœ‰æŒ‚èµ·ç»§ç»­æ“ä½œ
dispatch_ queue_t |	DispatchQueue|é˜Ÿåˆ—|
dispatch_ group_t |	DispatchGroup|é˜Ÿåˆ—ç»„|
dispatch_ data_t  |	DispatchData| åˆ†å‘æ•°æ®,åªå­˜åœ¨å†…å­˜ä¸­ |
dispatch_ io_t	| DispatchIO | æ“ä½œæ–‡ä»¶çš„ä¸€ä¸ªé€šé“(åŸºäºæµå’Œéšæœºå­˜å‚¨çš„æè¿°ç¬¦)
dispatch_ semaphore_t | DispatchSemaphore | åˆ†å‘ ä¿¡å·
dispatch_ source_t|DispatchSource | åˆ†å‘ æº
dispatch_ time_t|	DispatchTime, DispatchWalltime | å•ä¸ªåˆ†æ´¾ä»»åŠ¡



C	| Swift
|------|----| 
dispatch_ fd_t |	Int32
dispatch_ block_t |	() -> ()
dispatch_ queue_ attr_t	| DispatchQueueAttributes


çœ‹ä¸€ä¸‹OCä¸‹å¤šçº¿ç¨‹æ€ç»´å¯¼å›¾
![æ€ç»´å¯¼å›¾](https://xmindshare.s3.amazonaws.com/preview/SaVb-jWfujtF-94374.png)


å¤šçº¿ç¨‹çš„å®ç°çš„å››ç§æ–¹å¼

 - pthred
 - NSthread
 - GCD
 - NSOperation

å…·ä½“ä»‹ç»æŸ¥çœ‹ [http://www.jianshu.com/p/b91b42235285](http://www.jianshu.com/p/b91b42235285)

### 1. GCDå†™æ³•
### 2. å…¨å±€é˜Ÿåˆ—å’Œä¸»é˜Ÿåˆ—è·å–
### 3. æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ï¼ŒåŒæ­¥ã€å¼‚æ­¥
### 4. æš‚åœæˆ–ç»§ç»­é˜Ÿåˆ—


```
//MARK: æš‚åœæˆ–æ‰§è¡Œé˜Ÿåˆ—
func pauseorrsume() -> () {
    
//        DispatchQueue.init(label: "concurrentqueue1")
    
    //concurrent å¹¶å‘çº¿ç¨‹
    //é»˜è®¤åŒæ­¥çº¿ç¨‹
//        let queue:DispatchQueue = DispatchQueue(label: "processQueueName")
    
    let queue:DispatchQueue = DispatchQueue(label: "processQueueName", attributes: .concurrent)
    
    queue.async {
        for idx in 1..<5
        {
            sleep(1)
            print("âšªGM\t A:\(idx)")
        }
    }
    
    queue.async {
        for idx in 1..<5
        {
            sleep(1)
            print("ğŸ”´GM\t B:\(idx)")
        }
    }
     let time = DispatchTime.now() + .seconds(2)
    DispatchQueue.main.asyncAfter(deadline: time) {
        queue.suspend()
        print("æš‚åœ")
    }
    
    //æš‚åœä¹‹ååŠ å…¥çš„ä»»åŠ¡
    let time3 =  DispatchTime.now() + .seconds(6)
    DispatchQueue.main.asyncAfter(deadline: time3) {
        queue.async {
            for idx in 1..<5
            {
                sleep(1)
                print("ğŸ”µGM\t F:\(idx)")
            }
        }
    }
    
    
    let time2 =  DispatchTime.now() + .seconds(15)
    DispatchQueue.main.asyncAfter(deadline: time2) {
        queue.resume()
        print("ç»§ç»­")
        queue.async {
            for idx in 1..<5
            {
                sleep(1)
                print("ğŸ”¶GM\t E:\(idx)")
            }
        }
        
    }
    //å¼‚æ­¥ä»»åŠ¡
    queue.async {
        for idx in 1..<5
        {
            sleep(1)
            print("ğŸ”·GM\t C:\(idx)")
        }
    }
    
    
}

```

### 5. ä¸€æ¬¡æ€§æ‰§è¡Œï¼ˆå•ä¾‹ï¼‰

æ²¡æœ‰dispatch_onceä¹‹ç±»çš„ä»£ç ï¼Œè¯·ä½¿ç”¨swiftæ–¹å¼"é«˜çº§"ç”¨æ³•ï¼Œ

```
static let shareInstance:AClass

```

### 6. çº¿ç¨‹ç»„ï¼Œä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸å®Œæˆé€šçŸ¥

```

func queuegroup() -> () {
    
    let workItem:DispatchWorkItem = DispatchWorkItem.init {
        for idx in 1..<10
        {
            print("ğŸ”´GM\t A:\(idx)")
            sleep(1)
        }
    }
    
    let workItem2:DispatchWorkItem = DispatchWorkItem.init {
        for idx in 1..<5
        {
            print("ğŸ”µGM\t B:\(idx)")
            sleep(1)
        }
    }
    
    let workItem3:DispatchWorkItem = DispatchWorkItem.init {
        for idx in 1..<20
        {
            print("âšªGM\t B:\(idx)")
//                usleep(500)
            sleep(1)
        }
    }
    
    let queue:DispatchQueue = DispatchQueue(label: "processQueueName", attributes: .concurrent)
    
//        let queue:DispatchQueue = DispatchQueue(label: "workitemqueue", qos: .default)
    //attributes: .concurrent,target: nil
    let group:DispatchGroup = DispatchGroup.init();
    
    
    workItem2.notify(queue: queue) {
        print("ä»»åŠ¡äºŒå®Œæˆ")
    }
    
    workItem.notify(queue: queue) {
        print("ä»»åŠ¡ä¸€å®Œæˆ")
    }
    
    workItem3.notify(queue: queue) {
        print("ä»»åŠ¡ä¸‰å®Œæˆ")
    }
    
    queue.async(group: group, execute: workItem)
    
    queue.async(group: group, execute: workItem2)
    
    queue.async(group: group, execute: workItem3)
    
    
    group.notify(queue: queue) {
        print("ä»»åŠ¡å…¨éƒ¨å®Œæˆ")
    }
    
}
    
```

### 7. è¿­ä»£


### 8. DispatchSemaphoreä¿¡å·é‡(ä¸´ç•ŒåŒº) 
#### ä¸€å¥è¯è§£é‡Šï¼šç‹­è·¯ç›¸é€¢æ’é˜Ÿè¿‡

è¿™æ˜¯è§£å†³ä¸´ç•ŒåŒºçš„æ­»é”è§£é”ä¸€ç§æ–¹å¼ï¼Œæ¢å¥è¯æ˜¯å¯ä»¥å®ç°æ­»é”å’Œè§£é”ï¼Œæ€»å…±å°±ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹ï¼š

>
>- è®¾ç½®ä¸´ç•ŒåŒº   DispatchSemaphore(value: 1)
>- ç”³è¯·ä½¿ç”¨ä¸´ç•ŒåŒº(å¼€å§‹ç­‰å¾…) semaphore.wait()
>- é‡Šæ”¾ä¸´ç•ŒåŒº semaphore.signal() 


```
  //MARK:ä¸´ç•ŒåŒºï¼Œç‹­è·¯ç›¸é€¢æ’é˜Ÿè¿‡
    func signalsampore() -> () {  
        let higherPriority = DispatchQueue.global(qos: .userInitiated)
        let lowerPriority = DispatchQueue.global(qos: .utility)
        
        let semaphore = DispatchSemaphore(value: 1)
        
        func asyncPrint(queue: DispatchQueue, symbol: String) {
            queue.async {
                print("\(symbol) waiting")
                semaphore.wait()  // requesting the resource
               
                //ä¸´ç•ŒåŒºå¼€å§‹ ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™é‡Œ
                for i in 0...10 {
                    sleep(1)
                    print(symbol, i)
                }
                 print("\(symbol) signal")
                //ä¸´ç•ŒåŒºç»“æŸ
                semaphore.signal() // releasing the resource
            }
        }
        
        asyncPrint(queue: higherPriority, symbol: "ğŸ”´")
        asyncPrint(queue: lowerPriority, symbol: "ğŸ”µ")
}
```

[æ¨èåšå®¢](https://medium.com/swiftly-swift/a-quick-look-at-semaphores-6b7b85233ddb)


